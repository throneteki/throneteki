version: "3.8"

services:
  mongo:
    image: mongo:7
    restart: always
    volumes:
      - mongodb_data:/data/db
    networks:
      - throneteki

  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - throneteki

  lobby:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-1.0.0}
        SENTRY_KEY: ${SENTRY_KEY:-}
        SENTRY_AUTH_TOKEN: ${SENTRY_AUTH_TOKEN:-}
        HCAPTCHA_SITE_KEY: ${HCAPTCHA_SITE_KEY:-}
    image: throneteki-lobby:${VERSION:-latest}
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=4000
    volumes:
      - ./config/production.json5:/usr/src/app/config/local.json5:ro
      - card_images:/usr/src/app/public/img/cards
      - avatars:/usr/src/app/public/img/avatar
    depends_on:
      - mongo
      - redis
    networks:
      - throneteki

  gamenode:
    build:
      context: ..
      dockerfile: server/gamenode/Dockerfile
      args:
        VERSION: ${VERSION:-1.0.0}
    image: throneteki-node:${VERSION:-latest}
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=5000
      - SERVER=node1
      - HOST=${PUBLIC_DOMAIN:-localhost}
    volumes:
      - ./config/production.json5:/app/node/config/local.json5:ro
    depends_on:
      - redis
    networks:
      - throneteki

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - lobby
      - gamenode
    networks:
      - throneteki

  # One-time service to import card data into MongoDB.
  # Run with: docker compose run --rm fetchdata
  fetchdata:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-1.0.0}
    environment:
      - NODE_ENV=production
    volumes:
      - ./config/production.json5:/usr/src/app/config/local.json5:ro
      - card_images:/usr/src/app/public/img/cards
    depends_on:
      - mongo
    entrypoint: ["sh", "-c", "node server/scripts/fetchdata.js --no-images && node server/scripts/importstandalonedecks.js"]
    networks:
      - throneteki
    profiles:
      - setup

volumes:
  mongodb_data:
  redis_data:
  card_images:
  avatars:

networks:
  throneteki:
